

<!-- Chart code -->

<script>
    var chart;
    var lwc;   

    function chartDraw(data, signals, trades, orders_hst, symbol, qd_price) {
        const priceData = data.map(d => ({
            time: formatTime(d[0]) ,
            value: d[1]
        }));

        const pnlData = data.map(d => ({
            time: formatTime(d[0]) ,
            value: d[2]
        }));

        const signalData = signals.map(d => ({
            time: formatTime(d[0]) ,
            value: d[1],
            side: d[2],
        }));

        const tradesData = trades.map(d => ({
            time: formatTime(d[0]) ,
            value: d[1],
            side: d[2],
        }));
        
        const ordersData = [];
        Object.entries(orders_hst).forEach(([key, serie]) => {
            const serieData = serie.map(d => ({
                time: formatTime(d[0]),
                value: d[1],
                side: d[2],
            }));
            ordersData.push(serieData);
        });

        setTimeout( function () { //Timeout necesario para que se cree el div

            //Creando el chart
            if (priceData.length>0){
                lwc = new LWC('bt-chart',400);
                
                lwc.addPriceSeries(priceData,0 ,0 , qd_price, '');
                lwc.addPnlSeries(pnlData, 1, 100);

                lwc.addSignalsSeries(signalData)
                
                lwc.addTradesSeries(tradesData )
                
                for (const serie of ordersData) {
                    lwc.addOrdersSeries(serie )
                }
                chart = lwc.getChart();
                lwc.fullView();
            }
        },250);
    };

    

    function infoDraw(bt)
    {
        var div = $('#run');
        div.find('#general').html('<h6 class="text-info">General</h6>');
        div.find('#operaciones').html('<h6 class="text-info">Operaciones</h6>');
        div.find('#indicadores').html('<h6 class="text-info">Metricas</h6>');
        for (const items of bt.brief) {
            cls = '';
            if (items[3])
                cls = items[3]
            var html = '<div class="row pt-2">';
            html += '<div class="col-6">'+items[1]+'</div>';
            html += '<div class="col-6 '+cls+'">'+items[2]+'</div></div>'
            html += '</div>';
            div.find('#'+items[0]).append(html);
        } 

        qd_price = bt.qd_price;
        qd_qty = bt.qd_qty;

        var tbody = $('#trades-tab-pane table tbody');
        tbody.html('')
        for (const trade of bt.trades) {
            var cls = (trade[7]>0?'green':'red');
            var tr = '<tr class="'+cls+'">';
            var flag = (trade[5]>0?bt.order_flag[trade[5]]:'')
            var type = 'TO_DEF'
            //if (bt.events.length>0)
            //    type = (trade[9]>0?bt.order_type[trade[9]]:'')
            tr += '<td>'+trade[0]+'</td>';
            tr += '<td>'+trade[3]+'</td>';
            tr += '<td>'+to_dec(trade[6],2)+'</td>';
            tr += '<td>'+flag+' '+type+'</td>';
            tr += '<td class="text-end">'+to_dec(trade[2],qd_qty)+'</td>';
            tr += '<td class="text-end">'+to_dec(trade[1],qd_price)+'</td>';
            tr += '<td class="text-end">'+to_dec(trade[4],qd_price)+'</td>';
            tr += '<td class="text-end">'+to_dec(trade[7],2)+'</td>';
            tr += '<td class="text-end">'+to_dec(trade[8],2)+'</td>';
            tr += '<td class="text-end">'+trade[10]+'</td>';
            tr += '</tr>';
            tbody.append(tr);
        } 
        bootstrapFormat();
    }

</script>

<div class="row">
    <h5>Resultado <span id="add_resultado_title" class="text-info"></span></h5>
    
    <div class="container">
        <div class="row" id="resumen-tab-pane">
            <div class="row pt-4">
                <div class="col-4" id="general" style="font-size: 0.8em;" ></div>
                <div class="col-3" id="operaciones" style="font-size: 0.8em;" ></div>
                <div class="col-3" id="indicadores" style="font-size: 0.8em;" ></div>
            </div>
            
        </div>
        <div class="row pt-4" id="chardiv-tab-pane">
            <h6 class="text-info text-center">Grafica</h6>
            <div id="bt-chart"></div>
        </div>
        <div class="row pt-4" id="trades-tab-pane" >
            <h6 class="text-info text-center">Trades</h6>
            <table class="table-dg table-trade-info">
                <thead>
                    <tr>
                        <th>Compra</th>
                        <th>Venta</th>
                        <th>Duracion (Dias)</th>
                        <th>SL/TP</th>
                        <th class="text-end">Cantidad</th>
                        <th class="text-end">Compra</th>
                        <th class="text-end">Venta</th>
                        <th class="text-end">Resultado USD</th>
                        <th class="text-end">Resultado %</th>
                        <th class="text-end">Ordenes</th>
                    </tr>
                </thead>
                <tbody>
                    
                </tbody>
            </table>
        </div>
      </div>
</div>
